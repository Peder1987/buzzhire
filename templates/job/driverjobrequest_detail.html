{% extends 'account/dashboard_base.html' %}
{% load icons humanize django_bootstrap_breadcrumbs freelancer %}

{% block inner_breadcrumb %}
  {{ block.super }}
  {% if client %}
    {% breadcrumb 'Requested jobs' 'requested_jobs' %}
  {% else %}
    {% breadcrumb 'Job requests' 'driverjobrequest_admin_list' %}
  {% endif %}
{% endblock %}

{% block page_actions %}
    {% if request.user.is_admin %}
        <a class='btn btn-default' href='{% url 'job_matching_for_job_request' object.pk %}'>{{ 'job_matching'|icon }} Job matching</a>
        <a class='btn btn-default' href='{% url 'driverjobrequest_edit' object.pk %}'>{{ 'edit'|icon }} Edit</a>
        <a class='btn btn-default' href='{% url 'admin:job_driverjobrequest_change' object.pk %}'>{{ 'admin'|icon }} View in Django admin</a>
    {% endif %}
{% endblock %}

{% block content %}
    {% if object.status = 'IC' %}
        <div class='alert alert-warning text-center'>
            <p><strong>This job is still in checkout.</strong></p>
            {% if request.user.client == object.client %}
                <a class='btn btn-lg btn-warning' href='{% url 'driverjobrequest_checkout' object.pk %}'>Confirm and pay</a>
            {% endif %}
        </div>
    {% endif %}
        
    <div class='row'>
        <div class='col-md-4 col-md-push-8'>
            <h5>Details</h5>
            <table class='table table-striped'>
                <tr>
                    <th>Reference</th>
                    <td>
                        <span style='font-family: monospace;'>{{ object.reference_number }}</span>
                    </td>
                </tr>
                {% if request.user.is_admin %}
                    <tr>
                        <th>Client</th>
                        <td>
                            {{ object.client }}
                        </td>
                    </tr>
                    <tr>
                        <th>Client email</th>
                        <td>
                            {{ object.client.user.email }}
                        </td>
                    </tr>
                {% endif %}
                <tr>
                    <th>Date submitted</th>
                    <td>
                        {{ 'date'|icon }} {{ object.date_submitted.date }}<br>
                        {{ 'time'|icon }} {{ object.date_submitted.time }}
                    </td>
                </tr>
                

                <tr>
                    <th>Status</th>
                    <td>
                        <span class='label label-default'>{{ object.get_status_display }}</span>
                    </td>
                </tr>
                
             </table>
             <h5>Financial</h5>
             <table class='table table-striped'>
                {% if request.user.is_admin %}
                    <tr>
                        <th>Client pay per hour</th>
                        <td>
                            &pound;{{ object.client_pay_per_hour.amount }}
                        </td>
                    </tr>
                    <tr>
                        <th>Driver pay per hour</th>
                        <td>
                            &pound;{{ object.freelancer_pay_per_hour.amount }}
                        </td>
                    </tr>

                {% else %}
                    <tr>
                        <th>Pay per hour</th>
                        <td>
                            &pound;{{ object.client_pay_per_hour.amount }}
                        </td>
                    </tr>
                {% endif %}
                <tr>
                    <th>Inclusive of tips?</th>
                    <td>
                        {{ object.tips_included|yesno|icon }}
                    </td>
                </tr>
             </table>
             <h5>Location and date</h5>
             <table class='table table-striped'>
                <tr>
                    <th>Date and time</th>
                    <td>
                        {{ 'date'|icon }} {{ object.date }}<br>
                        {{ 'time'|icon }} {{ object.start_time }}
                    </td>
                </tr>
                <tr>
                    <th>Duration</th>
                    <td>
                        {{ object.duration }} hour{{ object.duration|pluralize }}
                    </td>
                </tr>
                <tr>
                    <th>Location</th>
                    <td>
                        <address>
                           {% include 'job/includes/location.html' %}
                        </address>
                    </td>
                </tr>
             </table>
        </div>
        
        <div class='col-md-8 col-md-pull-4'>
             <h5>Job requirements</h5>
             <table class='table table-striped'>
                 <tr>
                    <th>Number of drivers</th>
                    <td>
                        {{ object.number_of_freelancers }}
                    </td>
                </tr>
                 <tr>
                    <th>Vehicle type</th>
                    <td>
                        <p class='compact'><span class='label label-default'>{{ object.vehicle_type }}</span></p>
                    </td>
                </tr>
                 <tr>
                    <th>Minimum delivery box</th>
                    <td>
                        {{ object.get_minimum_delivery_box_display }}
                    </td>
                </tr>
                 <tr>
                    <th>Minimum driving experience</th>
                    <td>
                        {{ object.get_driving_experience_display }}
                    </td>
                </tr>
                 <tr>
                    <th>Must the driver supply their own vehicle?</th>
                    <td>
                        {{ object.own_vehicle|yesno|icon }}
                    </td>
                </tr>

                <tr>
                    <th>Phone requirement</th>
                    <td>
                        {{ object.get_phone_requirement_display }}
                    </td>
                </tr>

            </table>
            {% if object.comments %}
                <h5>Comments</h5>
                <div class='compact'>{{ object.comments|linebreaks }}</div>
            {% endif %}
            
            {% if request.user.is_admin %}
                <h5>Bookings</h5>
                {% if object.bookings.all %}
                    <table class='table middle-align'>
                        <thead>
                            <th>Driver</th>
                            <th>Booking reference</th>
                            <th></th>
                        </thead>
                        {% for booking in object.bookings.all %}
                           <tr>
                              <td>
                                <a href='{% url 'driver_detail' booking.freelancer.pk %}'>
                                    {% profile_photo booking.freelancer 'small' %}
                                    {{ booking.freelancer.get_full_name }}
                                </a>
                              </td>
                              <td class='monospace'>{{ booking }}</td>
                              <td class='text-right'><a class='btn btn-sm btn-default' href='{% url 'admin:booking_booking_change' booking.pk %}'>{{ 'edit'|icon }} edit</a>
                           </tr>
                        {% endfor %}
                    </table>
                    
                {% else %}
                    <p>No bookings yet.</p>
                {% endif %}
            {% endif %}
        </div>
    </div>
{% endblock %}