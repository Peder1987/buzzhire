{% extends 'account/dashboard_base.html' %}
{% load crispy_forms_tags icons %}

{% block content %}
    <p class='text-center'>
        Job matching for <a href='{{ form.job_request.get_absolute_url }}'><span style='font-family: monospace;'>{{ form.job_request }}</span></a>
        <a class='btn btn-default btn-xs' href='{% url 'job_matching' %}'>{{ 'clear'|icon }} Clear</a>
    </p>

    <div class='well'>
        {% if form.job_request %}
        {% endif %}
        <form method='get'>
            {% csrf_token %}
            <div class='row'>
                <div class='col-md-4'>
                    {{ form.date|as_crispy_field }}
                    {{ form.shift|as_crispy_field }}
                    {{ form.raw_postcode|as_crispy_field }}
                    {# form.respect_travel_distance|as_crispy_field #}
                </div>
                <div class='col-md-4'>
                    {{ form.phone_type|as_crispy_field }}
                    {{ form.client_pay_per_hour|as_crispy_field }}
                    {% if form.freelancer_pay_per_hour %}<p class='help-block'>Calculated driver rate: <strong>&pound;{{ form.freelancer_pay_per_hour.amount }}</strong>.</p>{% endif %}
                </div>
                <div class='col-md-4'>
                    {{ form.vehicle_types|as_crispy_field }}
                    {{ form.own_vehicle|as_crispy_field }}
                    {{ form.minimum_delivery_box|as_crispy_field }}
                </div>
            </div>
            {% include 'includes/forms/buttons.html' with submit_name='search' icon_name='job_matching' submit_text='Search drivers' cancel_url=request.path cancel_text='Reset' %} 
        </form>
    </div>
    {% if searched %}
        {% if object_list %}
            {% include 'includes/paginator_results_count.html' with results_description='drivers' %}
            <table class='table table-striped'>
                <thead>
                    <th>Ref</th>
                    <th>Name</th>
                    <th>Location</th>
                    <th>Maximum travel distance</th>
                    <th>Can drive</th>
                    <th>Can provide</th>
                    <th>Minimum pay per hour</th>
                    <th></th>
                </thead>
                <tbody>
                    {% for object in object_list %}
                        <tr>
                            <td><a href='{% url 'admin:driver_driver_change' object.pk %}'>{{ object.reference_number }}</a></td>
                            <td>{{ object.get_full_name }}</td>
                            <td>{% if object.postcode %}
                                    {{ object.postcode }}
                                    {% if form.include_distances %}
                                        {% with object.distance.mi|floatformat:'0' as distance %} 
                                            <br>({{ distance }} mile{{ distance|pluralize }} away)
                                        {% endwith %}
                                    {% endif %}
                                {% else %}unknown{% endif %}
                            </td>
                            <td>{% if object.postcode %}{{ object.travel_distance }} mile{{ object.travel_distance|pluralize }}{% endif %}</td>
                            <td>{% for vehicle_type in object.vehicle_types.all %}<p class='compact'><span class='label label-default'>{{ vehicle_type }}</span></p>{% endfor %}</td>
                            <td>{% for driver_vehicle_type in object.drivervehicletype_set.owned %}<span class='label label-primary'>{{ driver_vehicle_type }}</span><br>{% endfor %}</td>
                            <td>&pound;{{ object.minimum_pay_per_hour.amount }}</td>
                            <td><a class='btn btn-sm btn-default' href='{% url 'admin:booking_booking_add' %}'>{{ 'create'|icon }} Add booking</a> 
                        </tr>
                    {% endfor %}
                </tbody>
           </table>
           {% include 'includes/paginator.html' %}
        {% else %}
            <p>No results.</p>
        {% endif %}
    {% else %}
        <div class='alert alert-info'>
            Use the filters to search for a driver.
        </div>
    {% endif %}
    
{% endblock %}


{% block extrascripts %}
    {{ block.super }}
    {% include 'includes/forms/datetime_form_js.html' %}
{% endblock %}